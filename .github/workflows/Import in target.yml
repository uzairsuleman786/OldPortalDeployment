name: Import Power Pages to Target Environment
# Export solution from DEV environment
# Unpack, update version in Solution.xml and .nuspec file
# Pack and create branch
 
on:
workflow_dispatch:
 
jobs:
  export:
    runs-on: windows-latest

  Export-Branch:
    runs-on: powerapps
    env:
      RUNNER_DEBUG: 1
 
    steps:
 
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Install Power Platform Tools
      uses: microsoft/powerplatform-actions/actions-install@v1

    - name: Install Power Platform CLI
      run: |
        Invoke-WebRequest -Uri https://aka.ms/PowerAppsCLI -OutFile pac.msi
        Start-Process msiexec.exe -ArgumentList '/i pac.msi /quiet /norestart' -NoNewWindow -Wait

    - name: Add pac to PATH
      shell: pwsh
      run: |
        $pac = (Get-Item "$env:POWERPLATFORMTOOLS_PACPATH").Directory.FullName;
        "$pac" | Out-File -FilePath $env:GITHUB_PATH -Append

    - name: Log Current Directory
      run: |
        Write-Host "Current directory:"
        pwd

    - name: Log Directory Contents
      run: |
        Write-Host "Files in the current directory:"
        Get-ChildItem -Path . -Recurse  
    
    - name: Authenticate with Power Platform
      run: |
        pac auth create --name "OLDPORTAL" --url "https://orgbc24f670.crm.dynamics.com" --username "admin@CRM720692.onmicrosoft.com" --password "#W4^eG+p+u5L676wO="
    - name: Import Solution
      run: |
        pac paportal upload --path "exported_solution.zip/portalsitetest---site-p8dn9"
 
    - name: Branch Solution
      id: BranchSolution
      uses: microsoft/powerplatform-actions/branch-solution@latest
      with:
        solution-folder: exported_solution.zip
        solution-target-folder: exported_solution.zip/
        branch-name: OLDPORTAL-CI
        repo-token: ${{ secrets.PAT_TOKEN }}
        allow-empty-commit: true
